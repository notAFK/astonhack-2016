"use strict";!function(){var a=["ngRoute","ngCookies","truncate","sql","stats","common","overview","feed","console","tables","cluster","tableinfo","shardinfo","nodeinfo","checks","udc","translation","nvd3ChartDirectives","pascalprecht.translate"],b={"/":{templateUrl:"views/overview.html",controller:"OverviewController"},"/console":{templateUrl:"views/console.html",controller:"ConsoleController"},"/tables":{templateUrl:"views/tables.html",controller:"TableDetailController"},"/tables/:schema_name/:table_name":{templateUrl:"views/tables.html",controller:"TableDetailController"},"/nodes":{templateUrl:"views/node.html",controller:"NodeDetailController"},"/nodes/:node_id":{templateUrl:"views/node.html",controller:"NodeDetailController"}},c=document.getElementsByTagName("head")[0],d=function(a){var b=new XMLHttpRequest;b.open("GET",a,!1),b.send("");var d=document.createElement("script");d.type="application/javascript",d.text=b.responseText,c.appendChild(d)};$.get("conf/plugins.json",function(c){console.info("Loaded Modules:",a),console.info("Loaded Plugins:",c.map(function(a){return a.name}));for(var e=0;e<c.length;e++){var f=c[e];d(f.uri),a.push(f.name)}var g=angular.module("crate",a);g.config(["$routeProvider","$httpProvider",function(a,d){d.defaults.useXDomain=!0;for(var e in b)a.when(e,b[e]);for(var f=0;f<c.length;f++){var g=c[f].routing;if(g)for(var e in g)a.when(e,g[e])}a.otherwise({redirectTo:"/"})}]),g.config(["$translateProvider","$translatePartialLoaderProvider",function(a,b){b.addPart("."),a.useLoader("$translatePartialLoader",{urlTemplate:"{part}/i18n/{lang}.json"}).registerAvailableLanguageKeys(["en","de"],{"en_*":"en","de_*":"de","*":"en"}).determinePreferredLanguage().fallbackLanguage("en").useSanitizeValueStrategy(null),a.useCookieStorage()}]),g.run(["$rootScope","$translate",function(a,b){a.$on("$translatePartialLoaderStructureChanged",function(){b.refresh()})}]),g.run(["$window","$location",function(a,b){var c=$.url(a.location.href),d="./"+c.attr("file"),e=c.param("base_uri");e&&(localStorage.setItem("crate.base_uri",e),a.location.href=d+"#/")}]),angular.element(document).ready(function(){angular.bootstrap(document,["crate"])})})}(),angular.module("sql",[]).factory("queryResultToObjects",["_object",function(a){return function(b,c){return $.map(b.rows,function(b,d){return a(c,b)})}}]).factory("_object",function(){return function(a,b){if(a.length!=b.length)return{};for(var c={},d=0;d<a.length;d++)c[a[d]]=b[d];return c}}).factory("baseURI",["$location","$log",function(a,b){function c(c){var e=localStorage.getItem("crate.base_uri");if(!e){d||(b.warn("If you develop and run Crate Admin UI locally you need to set the base_uri. See README.rst for further information."),d=!0);var f="/_plugin/crate-admin/";e=a.protocol()+"://"+a.host()+":"+a.port()+window.location.pathname.replace(f,"")}return e.replace(/\/+$/,"")+c}var d=!1,e={getURI:c};return e}]).factory("SQLQuery",["$http","$log","$q","baseURI",function(a,b,c,d){function e(a,b,c){this.stmt=a,this.rows=[],this.cols=[],this.rowCount=0,this.duration=0,this.error=c,this.failed=!1,!this.error&&b?(this.rows=b.rows,this.cols=b.cols,this.rowCount=b.rowcount,this.duration=b.duration):this.failed=!0}return e.prototype.status=function(){var a="",c=this.stmt.split(" "),d=c[0].toUpperCase();return d in{CREATE:"",DROP:""}&&(d=d+" "+c[1].toUpperCase()),0==this.failed?(a=d+" OK ("+(this.duration/1e3).toFixed(3)+" sec)",b.info("Query status: "+a)):(a=d+" ERROR ("+(this.duration/1e3).toFixed(3)+" sec)",b.warn("Query status: "+a)),a},e.execute=function(b,f,g){var h={stmt:b};void 0==f||$.isEmptyObject(f)||(h.args=f);var i=c.defer(),j=c.defer(),k=j.promise;k.success=function(a){return k.then(function(b){a(b)}),k},k.error=function(a){return k.then(null,function(b){a(b)}),k},k.cancel=function(){i.reject()};var l={url:d.getURI("/_sql"),method:"POST",data:h,config:{timeout:i.promise}};return g===!0&&(l.params={error_trace:g}),a(l).success(function(a,c,d,f){j.resolve(new e(b,a,null))}).error(function(a,c,d,f){var g=null;c>=400&&a.error?(g=new Error(a.error.message),g.error_trace=a.error_trace,g.status=a.error.status):c>=400?(g=new Error(a),g.status=c):0===c&&(g=new Error("Connection refused"),g.status=c),j.reject(new e(b,a,g))}),k},e}]),angular.module("health",[]).factory("Health",function(){var a={},b=function c(a){this.set=function(a){this.level=isNaN(a)?c.UNKNOWN:a,this.name=c.NAMES[this.level]||"--"},this.toString=function(){return this.name},this.set(a)};return b.NAMES=["good","warning","critical"],b.NAMES.map(function(b,c){a[b]=c}),b.UNKNOWN=-1,b.GOOD=0,b.WARNING=1,b.CRITICAL=2,b.fromString=function(c){return new b(a[c])},b}),angular.module("stats",["sql","health","tableinfo","nodeinfo"]).factory("ClusterState",["$http","$interval","$timeout","$log","baseURI","SQLQuery","queryResultToObjects","TableList","Health","ShardInfo","NodeInfo","$q",function(a,b,c,d,e,f,g,h,i,j,k,l){var m,n,o,p,q,r={online:!0,tables:[],shards:[],partitions:[],cluster:[],name:"--",status:"--",load:["-.-","-.-","-.-"],loadHistory:[[],[],[]],version:null},s={},t=5e3,u=180,v=function(){a.get(e.getURI("/")).success(function(a){if("object"==typeof a){var b=a.version;r.version={number:b.number,hash:b.build_hash,snapshot:b.build_snapshot},w(!0)}else r.version=null,w(!1)}).error(function(a,b){w(!1)})},w=function(a){r.online&&!a?(r.online=!1,d.warn("Cluster is offline."),b.cancel(m),b.cancel(n),b.cancel(p),b.cancel(q),r.status="--",r.tables=[],r.cluster=[],r.name="--",r.load=["-.-","-.-","-.-"],r.loadHistory=[[],[],[]],r.version=null,o=b(v,t)):!r.online&&a&&(b.cancel(o),r.online=!0,d.info("Cluster is online."),m=b(B,t),B(),n=b(C,t),C(),p=b(D,t),D())},x=function(a){if(a.length==r.loadHistory.length)for(var b=r.loadHistory,c=0;c<a.length;c++)b[c].push(a[c]),b[c]=b[c].splice(-u,u)},y=function(a){if(a&&a.error)var b=a.error.status;(0===b||404===b)&&w(!1)},z=function(a){for(var b=a.length,c=[0,0,0],d=0;b>d;d++){var e=a[d].load;c[0]+=e[1]/b,c[1]+=e[5]/b,c[2]+=e[15]/b}return x(c),c},A=function(a){for(var b=a.length,c=0;b>c;c++){var d=a[c],e={timestamp:d.timestamp,data:d.fs.total};if(s[d.id]){var f=s[d.id],g=(e.timestamp-f.timestamp)/1e3,h=e.data.reads-f.data.reads,i=e.data.writes-f.data.writes,j=e.data.bytes_read-f.data.bytes_read,k=e.data.bytes_written-f.data.bytes_written;d.iostats={rps:e.data.reads>0?h/g:-1,wps:e.data.writes>0?i/g:-1,rbps:e.data.bytes_read>0?j/g:-1,wbps:e.data.bytes_written>0?k/g:-1}}else d.iostats={rps:-1,wps:-1,rbps:-1,wbps:-1};s[d.id]=e}return a},B=function(){h.execute().then(null,null,function(a){if(a.success||!r.online){var b=a.data.tables.reduce(function(a,b,c){var d=i.fromString(b.health).level;return Math.max(d,a)},0);r.status=new i(b).name,r.tables=a.data.tables}else r.status="--",r.tables=[]})},C=function(){k.executeNodeQuery().then(function(a){r.online&&(r.load=z(a),r.cluster=A(a),k.executeClusterQuery().then(function(a){if(r.online){r.name=a[0].name,r.master_node=a[0].master_node;var b={name:r.name,master_node:r.master_node,nodes:r.cluster.length};k.deferred.resolve(b)}},y))},y)},D=function(){r.online&&j.executeTableStmt().then(function(a){j.executeShardStmt().then(function(b){j.executePartStmt().then(function(c){j.executeRecoveryStmt().then(function(d){r.shards=b,r.tables=a,r.partitions=c,r.recovery=d;var e={tables:r.tables,shards:r.shards,partitions:r.partitions,recovery:r.recovery};j.deferred.resolve(e)})["catch"](function(){var a={tables:r.tables,shards:r.shards,partitions:r.partitions};j.deferred.reject(a)})})["catch"](function(){var a={tables:r.tables,shards:r.shards};j.deferred.reject(a)})})["catch"](function(){var a={tables:r.tables};j.deferred.reject(a)})})["catch"](function(){j.deferred.reject({})})};return v(),B(),m=b(B,t),D(),p=b(D,t),C(),c(C,500),n=b(C,t),{data:r,HISTORY_LENGTH:u}}]),angular.module("tableinfo",["sql"]).factory("TableInfo",function(){var a=["STARTED","RELOCATING"],b=function(b){return a.indexOf(b.routing_state)>-1};return function(a,c,d,e){var a=a?angular.copy(a):[],d=d?angular.copy(d):[],f=d.length>0,g=c||0,e=e||[],h=function(){return a.filter(function(a,b){return a.primary})}(),i=function(){return h.reduce(function(a,b,c){return a+b.count},0)}(),j=function(){return a.filter(function(a,c){return b(a)})}(),k=function(){return j.reduce(function(a,b,c){return a+b.count},0)}(),l=function(){return a.filter(function(a,c){return b(a)&&a.primary===!0}).reduce(function(a,b,c){return a+b.count},0)}(),m=function(){return h.reduce(function(a,b,c){return a+b.size},0)}(),n=function(){return h.reduce(function(a,b,c){return a+b.sum_docs},0)}(),o=function(){return f&&0===k?0:Math.max(0,g-l)}(),p=function(){return a.filter(function(a,b){return"UNASSIGNED"==a.routing_state}).reduce(function(a,b,c,d){return a+b.count},0)}(),q=function(){return a.filter(function(a,b){return"INITIALIZING"==a.routing_state&&null===a.relocating_node}).reduce(function(a,b,c,d){return a+b.count},0)}(),r=function(){return Math.max(0,p+q-o)}(),s=function(){return h.reduce(function(a,b,c,d){return a+b.avg_docs/d.length},0)}(),t=function(){return Math.ceil(s*p)}(),u=function(){var b=a.reduce(function(a,b,c){return a+b.count},0);return Math.ceil(s*b)}(),v=function(){var a=j.reduce(function(a,b,c,d){return a+b.avg_docs/d.length},0);return Math.ceil(a*o)}(),w=function(){return f&&0===k?"good":0===i?"critical":o>0?"critical":p>0||r>0?"warning":"good"}(),x=0===a.length||0===e.length?100:function(){var a=e.filter(function(a,b){return a.recovery_stage&&"DONE"===a.recovery_stage}).reduce(function(a,b,c,d){return[a[0]+100*b.count,a[1]+b.count]},[0,0]),b=e.filter(function(a,b){return a.recovery_stage&&"DONE"!==a.recovery_stage}).reduce(function(a,b,c,d){return[a[0]+b.recovery_percent*b.count,a[1]+b.count]},[0,0]),c=e.filter(function(a,b){return null===a.recovery_stage}).reduce(function(a,b,c,d){return[0,a[1]+b.count]},[0,0]),d=(a[0]+b[0]+c[0])/(a[1]+b[1]+c[1]);return d}();this.asObject=function(){return{shards_configured:g,health:w,shards_started:k,shards_missing:o,shards_underreplicated:r,records_total:n,records_total_with_replicas:u,records_unavailable:v,records_underreplicated:t,size:m,partitioned:f,partitioned_by:d,recovery_percent:x}}}}).factory("TableList",["$timeout","$q","TableInfo","SQLQuery","roundWithUnitFilter","bytesFilter","ShardInfo",function(a,b,c,d,e,f,g){var h=b.defer(),i={tables:[]},j=null,k=5e3,l={good:2,warning:1,critical:0,"--":0},m={good:"label-success",warning:"label-warning",critical:"label-danger","--":""},n={good:"panel-success",warning:"panel-warning",critical:"panel-danger","--":"panel-default"},o=function(a,b){return l[a.health]<l[b.health]?-1:l[a.health]>l[b.health]?1:a.name<b.name?-1:a.name>b.name?1:0},p=function(b,d,f,g,l){var p=d||[],r=f||[],s=g||[],t=l||[];if(b&&p.length){for(var u=0;u<p.length;u++){var v=p[u],w=r.filter(function(a,b){return a.table_name===v.name&&a.schema_name==v.schema_name}),x=s.filter(function(a,b){return a.table_name===v.name&&a.schema_name==v.schema_name}),y=t.filter(function(a,b){return a.table_name===v.name&&a.schema_name==v.schema_name});v.partitioned_by&&1===x.length&&(v.shards_configured=x[0].num_shards);var z=new c(w,v.shards_configured,v.partitioned_by,y),A=z.asObject();$.extend(v,A),v.health_label_class=m[v.health],v.health_panel_class=n[v.health],v.type_display_name="blob"==v.schema_name?"TABLE.BLOBS":"TABLE.RECORDS";var B=v.shards_configured+" Shards";B+=" / "+v.replicas_configured+" Replicas",v.records_unavailable?B=e(v.records_unavailable,1)+" Unavailable Records / "+B:v.shards_underreplicated&&(B=v.shards_underreplicated+" Underreplicated Shards / "+B),v.records_underreplicated&&(B=v.records_underreplicated+" Underreplicated Records / "+B),v.summary=B}i.tables=p.sort(o)}else i.tables=[];h.notify({success:b,data:i}),j=a(q,k)},q=function r(){a.cancel(j),g.deferred.promise.then(function(a){p(!0,a.tables,a.shards,a.partitions,a.recovery)})["catch"](function(a){jQuery.isEmptyObject(a)||(a.tables&&a.shards&&a.recovery?p(!0,a.tables,a.shards,null,a.recovery):a.tables?p(!0,a.tables):p(!1))})["finally"](function(){g.deferred.promise=b.defer().promise,r()})};return q(),{data:i,execute:function(){return h.promise}}}]),angular.module("shardinfo",[]).factory("ShardInfo",["SQLQuery","queryResultToObjects","$q",function(a,b,c){var d={deferred:c.defer()},e="select table_name, schema_name, format('%s.%s', schema_name, table_name) as fqn, number_of_shards, number_of_replicas, partitioned_by from information_schema.tables where schema_name not in ('information_schema', 'sys', 'pg_catalog')",f="SELECT table_name, schema_name, format('%s.%s', schema_name, table_name) AS fqn, _node['id'] AS node_id, state, routing_state, relocating_node, count(*), \"primary\", sum(num_docs), avg(num_docs), sum(size) FROM sys.shards GROUP BY table_name, schema_name, fqn, node_id, state, routing_state, relocating_node, \"primary\"",g="select table_name, schema_name, format('%s.%s', schema_name, table_name) as fqn, sum(number_of_shards) as num_shards from information_schema.table_partitions group by table_name, schema_name, fqn",h="SELECT table_name, schema_name, recovery['stage'] AS recovery_stage, avg(recovery['size']['percent']), count(*) as count FROM sys.shards GROUP BY table_name, schema_name, recovery_stage";return d.executeTableStmt=function(){var d=c.defer(),f=d.promise;return a.execute(e).success(function(a){var c=b(a,["name","schema_name","fqn","shards_configured","replicas_configured","partitioned_by"]);d.resolve(c)}).error(function(){d.reject()}),f},d.executeShardStmt=function(){var d=c.defer(),e=d.promise;return a.execute(f).success(function(a){var c=b(a,["table_name","schema_name","fqn","node_id","state","routing_state","relocating_node","count","primary","sum_docs","avg_docs","size"]);d.resolve(c)}).error(function(){d.reject()}),e},d.executePartStmt=function(){var d=c.defer(),e=d.promise;return a.execute(g).success(function(a){var c=b(a,["table_name","schema_name","fqn","num_shards"]);d.resolve(c)}).error(function(){d.reject()}),e},d.executeRecoveryStmt=function(){var d=c.defer(),e=d.promise;return a.execute(h).success(function(a){var c=b(a,["table_name","schema_name","recovery_stage","recovery_percent","count"]);d.resolve(c)}).error(function(){d.reject()}),e},d}]),angular.module("nodeinfo",[]).factory("NodeHealth",function(){var a=function b(a){var c=function(a){return a>b.THRESHOLD_CRITICAL?2:a>b.THRESHOLD_WARNING?1:0},d=Math.max(a.fs.used_percent,a.heap.used_percent),e=c(d);this.value=e,this.status=["good","warning","critical"][e]};return a.THRESHOLD_CRITICAL=98,a.THRESHOLD_WARNING=90,a}).factory("NodeInfo",["SQLQuery","queryResultToObjects","$q",function(a,b,c){var d={deferred:c.defer()},e="SELECT id, name, hostname, rest_url, port, heap, fs, os['cpu'], load, version, os['probe_timestamp'], process['cpu'], os_info['available_processors'] FROM sys.nodes ORDER BY id",f=["id","name","hostname","rest_url","port","heap","fs","cpu","load","version","timestamp","proc_cpu","num_cores"];d.executeNodeQuery=function(){var d=c.defer();return a.execute(e).success(function(a){var c=b(a,f);d.resolve(c)}).error(function(){d.reject()}),d.promise};var g="select name, master_node from sys.cluster",h=["name","master_node"];return d.executeClusterQuery=function(){var d=c.defer();return a.execute(g).success(function(a){d.resolve(b(a,h))}).error(function(){d.reject()}),d.promise},d}]).provider("NodeListInfo",function(){var a={sort:{col:["health_value","name"],desc:!1},sortBy:function(a){0===this.sort.col.indexOf(a)?this.sort.desc=!this.sort.desc:(this.sort.col=this.sort.col.reverse(),this.sort.desc=!1)},sortClass:function(a){return 0===this.sort.col.indexOf(a)?this.sort.desc?"fa fa-chevron-down":"fa fa-chevron-up":""}};this.$get=function(){return a}}).factory("prepareNodeList",["NodeHealth",function(a){var b={good:"label-success",warning:"label-warning",critical:"label-danger","--":""};return function(c,d){for(var e=[],f=0;f<c.length;f++){var g=angular.copy(c[f]);g.health=new a(g),g.health_value=g.health.value,g.health_label_class=b[g.health.status],g.health_panel_class=b[g.health.status],g.heap.used_percent=100*g.heap.used/g.heap.max,g.heap.free_percent=100-g.heap.used_percent,g.master_node=g.id===d,e.push(g)}return e}}]).factory("compareByHealth",function(){return function(a,b){return a.health.value<b.health.value?-1:a.health.value>b.health.value?1:a.name<b.name?-1:a.name>b.name?1:0}}),angular.module("checks",[]).factory("ClusterCheck",["SQLQuery","queryResultToObjects","$q",function(a,b,c){var d={deferred:c.defer()},e="SELECT id, severity, description, passed FROM sys.checks WHERE passed = false ORDER BY severity DESC, id",f=["id","severity","description","passed"];return d.execute=function(){var d=c.defer(),g=d.promise;return a.execute(e).success(function(a){var c=b(a,f);d.resolve(c)}).error(function(){d.reject()}),g},d}]).factory("NodeCheck",["SQLQuery","queryResultToObjects","$q",function(a,b,c){var d={deferred:c.defer()},e="SELECT c.id, c.severity, c.description, c.passed, c.node_id, n.name, c.acknowledged FROM sys.node_checks AS c, sys.nodes AS n WHERE c.node_id = n.id AND c.passed = false AND acknowledged = false ORDER BY c.severity DESC, n.name",f=["id","severity","description","passed","node_id","node_name","acknowledged"];return d.execute=function(){var d=c.defer(),g=d.promise;return a.execute(e).success(function(a){var c=b(a,f),e={};c.map(function(a){var b=a.id;b in e||(a.nodes=[],e[b]=a),e[b].nodes.push({name:a.node_name,id:a.node_id})});var g=Object.keys(e).map(function(a){return e[a]});d.resolve(g)}).error(function(){d.reject()}),g},d}]).factory("ChecksService",["$timeout","$q","NodeCheck","ClusterCheck","ClusterState",function(a,b,c,d,e){var f={checks:{},success:!1,refresh:function(){h(!0)}},g=0,h=function i(e){b.all([d.execute(),c.execute()]).then(function(b){f.checks.cluster_checks=b[0],f.checks.node_checks=b[1],f.success=!0,g=0,e!==!0&&a(i,6e4)})["catch"](function(){f.success=!1,g++,e!==!0&&a(i,500*g)})};return a(h,2e3),f}]),angular.module("udc",[]).factory("UdcSettings",["SQLQuery","queryResultToObjects","$q",function(a,b,c){var d=c.defer(),e=d.promise;e.success=function(a){return e.then(a,null,null),e},e.error=function(a){return e.then(null,a,null),e};var f="SELECT settings['udc']['enabled'] as enabled, id as cluster_id from sys.cluster",g=a.execute(f);return g.success(function(a){var c=b(a,["enabled","cluster_id"]);d.resolve(c[0])}).error(function(a){d.reject(null,"could not load udc setting")}),{SegmentIoToken:"sfTz0KpAhR0KmOH4GnoqbpLID71eaB3w",availability:e}}]).factory("Uid",function(){var a=function(a){this.uid=a};return a.create=function(b){return new a(b)},a.NAME="uid",a.prototype.isValid=function(){return this.uid?null!==this.uid.match(/^[a-f0-9]{32}$/):!1},a.prototype.toString=function(){return this.uid},a}).factory("UidLoader",["$q","Uid",function(a,b){var c=null,d=function(a){var b=document.createElement("iframe");return b.id="ifr"+(new Date).getTime(),b.style.width="0px",b.style.height="0px",b.src=a,document.getElementsByTagName("body")[0].appendChild(b),b},e="cdn.crate.io",f="/libs/crate/uid.html";return{load:function(){var g=a.defer(),h=g.promise;if(h.success=function(a){return h.then(a,null,null),h},h.error=function(a){return h.then(null,a,null),h},h.notify=function(a){return h.then(null,null,a),h},null===c){window.addEventListener("message",function(a){if(a.origin.match(e)){g.notify(a);var d=b.create(a.data[b.NAME]);d.isValid()?(c=d,g.resolve(d)):g.reject(new Error("Cookie failed to load"))}},!1);var i="https:"===window.location.protocol?"https:":"http:";d(i+"//"+e+f)}else g.resolve(c);return h}}}]),angular.module("translation",[]).factory("Translation",[function(){var a=this;return a.interpolate=function(a,b){for(var c in b){var d=new RegExp("\\{"+c+"\\}","gi");a=a.replace(d,b[c])}return a},a}]);var commons=angular.module("common",["stats","udc"]).controller("StatusBarController",["$scope","$log","$location","$translate","$sce","ClusterState","ChecksService",function(a,b,c,d,e,f,g){var h=["good","warning","critical","--"],i=["label-success","label-warning","label-danger","label-danger"],j=h.reduce(function(a,b,c){return a[b]=i[c],a},{}),k="https://crate.io/docs",l=function(a){return e.trustAsResourceUrl(k+(a?"/en/"+a.number:"/stable")+"/")};a.cluster_color_label="",a.config_label="",a.$watch(function(){return g},function(b){if(b.success===!0){var c=[];c.push.apply(c,b.checks.cluster_checks),c.push.apply(c,b.checks.node_checks);var f=c.reduce(function(a,b,c){return Math.max(a,b.severity)},1);d(["STATUSBAR.CHECK","STATUSBAR.CHECKS","STATUSBAR.FAILED"]).then(function(b){a.checks_message=e.trustAsHtml([c.length,1==c.length?b["STATUSBAR.CHECK"]:b["STATUSBAR.CHECKS"],b["STATUSBAR.FAILED"]].join(" ")),a.config_label=i[Math.min(f-1,i.length-1)]})}else d(["STATUSBAR.OFFLINE"]).then(function(b){a.checks_message=e.trustAsHtml(b["STATUSBAR.CLUSTER_OFFLINE"])}),a.config_label=""},!0),a.$watch(function(){return f.data},function(b){var c=[],d=b.cluster.filter(function(a,b){var d=!1;if(a.version){var e=a.version.build_hash;d=-1==c.indexOf(e),c.push(e)}return d}).map(function(a,b){return a.version.number});a.versions=d,a.version_warning=d.length>1,a.cluster_state=b.status,a.cluster_name=b.name,a.num_nodes=b.cluster.length,a.load1="-.-"==b.load[0]?b.load[0]:b.load[0].toFixed(2),a.load5="-.-"==b.load[1]?b.load[1]:b.load[1].toFixed(2),a.load15="-.-"==b.load[2]?b.load[2]:b.load[2].toFixed(2),a.version=b.version,a.docs_url=l(b.version),a.cluster_color_label=b.online?j[b.status]:""},!0),$("[rel=tooltip]").tooltip({placement:"bottom"})}]).controller("NavigationController",["$scope","$location","NavigationService",function(a,b,c){a.navBarElements=c.navBarElements,a.isActive=function(a){return"/"==a?a===b.path():b.path().substr(0,a.length)==a}}]).service("NavigationService",function(){this.navBarElements=[],this.addNavBarElement=function(a,b,c,d){"/"!=c.charAt(0)&&(c="/"+c);var e={text:b,iconClass:a,urlPattern:c};"undefined"==typeof d?this.navBarElements.push(e):0>d||d>=this.navBarElements.length?this.navBarElements.push(e):this.navBarElements.splice(d,0,e)},this.updateNavBarElement=function(a,b){"/"!=a.charAt(0)&&(a="/"+a);var c=this.navBarElements.filter(function(b){return b.urlPattern==a});0!==c.length&&(c[0].text=b)}}).directive("focus",["$timeout",function(a){return{scope:{trigger:"@focus"},link:function(b,c){b.$watch("trigger",function(b){b&&a(function(){c[0].focus()})})}}}]).directive("fixBottom",function(){return function(a,b,c){var d=$(b),e=$(".side-nav .navbar-nav"),f=$(window),g=function(){a.fixBottom=e.offset().top+e.height()+d.height()<f.height()};f.on("resize",g),g()}}).controller("HelpMenuController",["$scope","UidLoader","UdcSettings",function(a,b,c){var d=null;a.user={uid:null},analytics.load(c.SegmentIoToken),analytics.ready(function(){var a=analytics.user();d={id:a.id(),traits:a.traits()}});var e=function(b){null!=b.user.uid&&(analytics.setAnonymousId(b.user.uid),analytics.identify(b.user.uid),analytics.page(),analytics.track("visited_admin",{version:a.version.number,cluster_id:b.cluster_id}))};c.availability.success(function(c){c.enabled===!0&&b.load().success(function(b){a.user.uid=b.toString(),e({user:a.user,cluster_id:c.cluster_id})}).error(function(a){console.warn(a)})})}]).controller("LanguageSwitchController",["$scope","$translate",function(a,b){a.changeLanguage=function(a){a="auto"===a?b.preferredLanguage():a,b.use(a)}}]);commons.run(["NavigationService","$translate","$filter","$rootScope",function(a,b,c,d){a.addNavBarElement("fa fa-th-large",c("translate","NAVIGATION.OVERVIEW"),"/"),a.addNavBarElement("fa fa-code",c("translate","NAVIGATION.CONSOLE"),"/console"),a.addNavBarElement("fa fa-table",c("translate","NAVIGATION.TABLE"),"/tables"),a.addNavBarElement("fa fa-sitemap",c("translate","NAVIGATION.CLUSTER"),"/nodes"),d.$on("$translateChangeSuccess",function(){b(["NAVIGATION.OVERVIEW","NAVIGATION.CONSOLE","NAVIGATION.TABLE","NAVIGATION.CLUSTER"]).then(function(b){a.updateNavBarElement("/",b["NAVIGATION.OVERVIEW"]),a.updateNavBarElement("/console",b["NAVIGATION.CONSOLE"]),a.updateNavBarElement("/tables",b["NAVIGATION.TABLE"]),a.updateNavBarElement("/nodes",b["NAVIGATION.CLUSTER"])})})}]),angular.module("feed",["stats","udc"]).factory("FeedService",["$http",function(a){return{parse:function(b){return a.jsonp(b,{cache:!1})}}}]).factory("NotificationService",["$http",function(a){var b=null,c="crate.readNotifications";return{readItems:function(){if(null===b){var a=localStorage.getItem(c);b=a?JSON.parse(a):[]}return b},markAsRead:function(a){var d=this.readItems();d.push(a),b=d,localStorage.setItem(c,JSON.stringify(d))}}}]).controller("NotificationsController",["$scope","$sce","$http","$filter","FeedService","NotificationService","ClusterState","UdcSettings","UidLoader",function(a,b,c,d,e,f,g,h,i){var j=function(a,b){return a.indexOf("?")>-1?a+"&"+b:a+"?"+b},k=5,l="https://crate.io",m="udc.enabled=false";a.blog_url=l+"/blog",a.demo_url=l+"/demo",a.version_url=l+"/versions.json",a.feed_url=l+"/feed/developernews.json",a.menu_url=l+"/feed/menu.json",h.availability.success(function(f){f.enabled!==!0&&(a.blog_url=j(a.blog_url,m),a.demo_url=j(a.demo_url,m),a.version_url=j(a.version_url,m),a.feed_url=j(a.feed_url,m),a.menu_url=j(a.menu_url,m)),a.showUpdate=!1,a.numUnread=0,a.entries=[];var h;c.get(a.version_url,{withCredentials:!0}).success(function(a){a&&a.crate&&(h=a.crate)}),a.$watch(function(){return g.data},function(b){a.showUpdate=b.version&&h&&h>b.version.number,a.stableVersion=h,a.serverVersion=b.version?b.version.number:"",a.noNotifications=!a.showUpdate&&0===a.entries.length},!0),a.noNotifications=!0,e.parse(a.feed_url).then(function(c){var e=d("characters");if(200===c.status&&c.data.length>0){var f=c.data.splice(0,k),g=f.length;f.map(function(a,c){a.title=b.trustAsHtml(a.title),a.preview=b.trustAsHtml(e(a.excerpt,150)),a.timestamp=new Date(a.date),a.id=a.timestamp.getTime().toString(32),isRead(a)&&g--}),a.entries=f,a.numUnread=g}}),c.get(j(a.menu_url,"callback=JSON_CALLBACK")).success(function(b){b&&b.data&&(a.menu=b.data),i.load().success(function(b){null!==b&&f.enabled===!0&&a.menu.map(function(a,c){a.url=j(a.url,"ajs_uid="+b.toString()),a.url=j(a.url,"ajs_aid="+b.toString())})})})}),a.markAsRead=function(b){if("all"===b){for(var c=a.entries,d=0;d<c.length;d++)f.markAsRead(c[d].id);a.numUnread=0}else b&&(f.markAsRead(b.id),a.numUnread=Math.max(0,a.numUnread-1))},a.isRead=function(a){for(var b=f.readItems(),c=a.id,d=0;d<b.length;d++)if(b[d]===c)return!0;return!1},a.menu=[{url:"https://crate.io/demo?utm_source=adminui&utm_medium=browser&utm_term=&utm_content=demolink&utm_campaign=newsfeed&ajs_event=clicked_demo_link",title:"Schedule a 1-ON-1 demo with a Crate engineer"},{url:"https://crate.io/blog?utm_source=adminui&utm_medium=browser&utm_term=&utm_content=morelink&utm_campaign=newsfeed&ajs_event=clicked_more_link",title:"More"}]}]),angular.module("overview",["stats","checks","ngSanitize"]).factory("ZeroArray",function(){return function(a){for(var b=new Array(a),c=0;c<b.length;c++)b[c]=0;return b}}).factory("HistoryChart",function(){return function(a){var b=[{key:"Load 1",values:[],color:"#55d4f5",area:!0},{key:"Load 5",values:[],color:"#5987ff"},{key:"Load 15",values:[],color:"#115097"}];this.size=a,this.data=function(){return b},this.update=function(a){for(var c=[[],[],[]],d=0;d<this.size;d++)c[0][d]=[d,a[0][d]],c[1][d]=[d,a[1][d]],c[2][d]=[d,a[2][d]];for(var d=0;d<c.length;d++)b[d].values=c[d];return this}}}).controller("OverviewController",["$scope","$location","$log","$timeout","$interval","ClusterState","HistoryChart","ZeroArray","ChecksService","SQLQuery",function(a,b,c,d,e,f,g,h,i,j){var k=null,l={good:"panel-success",warning:"panel-warning",critical:"panel-danger","--":"panel-default"};a.available_data="--",a.records_unavailable="--",a.replicated_data="--",a.records_total="--",a.records_underreplicated="--",a.cluster_state="--",a.cluster_color_class="panel-default",a.chart={data:[]},a.$watch(function(){return i},function(b){b.success===!0?a.checks=b.checks:a.checks={node_checks:[],cluster_check:[]}},!0),a.refresh=i.refresh;var m=function(a,b){a.splice(a.indexOf(b),1)},n=function(b){m(a.checks.node_checks,b)};a.dismissCheckByNode=function(a,b){var c="UPDATE sys.node_checks SET acknowledged = TRUE WHERE node_id = ? AND id = ?";j.execute(c,[a.id,b.id]).success(function(c){m(b.nodes,a),0===b.nodes.length&&n(b)})},a.dismissCheck=function(a){var b="UPDATE sys.node_checks SET acknowledged = TRUE WHERE id = ?";j.execute(b,[a.id]).success(function(){n(a)})},a.$watch(function(){return f.data},function(b){var c=(new Date).getTime();if(!(k&&100>c-k)){if(k=c,a.cluster={name:b.name,state:b.status},a.cluster_color_class=l[b.status],b.loadHistory[0].length>0&&p(b.loadHistory),!b.tables||!b.tables.length)return a.available_data=100,a.records_unavailable=0,a.replicated_data=100,a.records_total=0,a.records_total_with_replicas=0,void(a.records_underreplicated=0);var d=b.tables;a.records_underreplicated=d.reduce(function(a,b,c){return b.records_underreplicated+a},0),a.records_unavailable=d.reduce(function(a,b,c){return b.records_unavailable+a},0),a.records_total=d.reduce(function(a,b,c){return b.records_total+a},0),a.records_total_with_replicas=d.reduce(function(a,b,c){return b.records_total_with_replicas+a},0),a.records_total_with_replicas>0?(a.replicated_data=Math.max(0,a.records_total_with_replicas-a.records_underreplicated)/a.records_total_with_replicas*100,a.available_data=Math.max(0,a.records_total_with_replicas-a.records_unavailable)/a.records_total_with_replicas*100):(a.replicated_data=100,a.available_data=100)}},!0);var o=new g(f.HISTORY_LENGTH),p=function(b){for(var c=b[0].length,d=[h(f.HISTORY_LENGTH-c),h(f.HISTORY_LENGTH-c),h(f.HISTORY_LENGTH-c)],e=0;e<d.length;e++)d[e].push.apply(d[e],b[e]);a.chart.data=o.update(d).data()};$("[rel=tooltip]").tooltip({placement:"top"}),a.$on("$destroy",function(a){window.onresize=null})}]),angular.module("console",["sql"]).directive("console",["SQLQuery","$timeout",function(a,b){return{restrict:"A",controller:["$scope","$translate",function(b,c){var d=this,e=null,f="",g="1"===localStorage.getItem("crate.console.displayed_error_trace_hint");d.recentQueries=[],b.showErrorTrace="1"===localStorage.getItem("crate.console.error_trace"),b.error={hide:!0,message:"",error_trace:""},b.info={hide:!0,message:""},d.setInputScope=function(a){e=a};var h=Ladda.create(document.querySelector("button[type=submit]"));b.storeInLocalStorageChanged=function(){localStorage.setItem("crate.console.store_queries",b.useLocalStorage===!0?"1":"0")},b.showErrorTraceChanged=function(){localStorage.setItem("crate.console.error_trace",b.showErrorTrace===!0?"1":"0")};var i=function(){var a=localStorage.getItem("crate.console.query_list");d.recentQueries=a?JSON.parse(a):[]},j=function(a){b.useLocalStorage&&i(),d.recentQueries[d.recentQueries.length-1]!==a&&d.recentQueries.push(a+";"),b.useLocalStorage&&localStorage.setItem("crate.console.query_list",JSON.stringify(d.recentQueries)),e.recentCursor=-1};b.hide=function(a){a.hide=!0,a.message=""},b.toggleOptions=function(){$("#console-options").slideToggle(),b.info.hide=!0,b.info.message="",b.showErrorTrace||g||$("#show-error-trace").addClass("blink")},b.clearLocalStorage=function(){c(["CONSOLE.CLEAR_HISTORY_MSG","CONSOLE.CLEAR_HISTORY_MSG_PLURAL"]).then(function(a){var c=JSON.parse(localStorage.getItem("crate.console.query_list")||"[]");localStorage.setItem("crate.console.query_list",JSON.stringify([])),e.recentCursor=0,d.recentQueries=[];var f=c.length?0:c.length+" ";f+=0==c.length||1==c.length?a["CONSOLE.CLEAR_HISTORY_MSG"]:a["CONSOLE.CLEAR_HISTORY_MSG_PLURAL"],b.info.message=f,b.info.hide=!1})};var k=localStorage.getItem("crate.console.store_queries")||"1";b.useLocalStorage=!!parseInt(k),i(),d.execute=function(c){var d=c.replace(/^\s+|\s+$/g,"");""!==d&&(d=d.replace(/([^;]);+$/,"$1"),d.match(/^\s*select\s/gi)&&!d.match(/limit\s+\d+/gi)&&(d+=" limit 100"),j(d),h.start(),$("#console-options").slideUp(),a.execute(d,{},b.showErrorTrace).success(function(a){h.stop(),b.error.hide=!0,
b.error.message="",b.error.error_trace="",b.info.hide=!0,b.info.message="",b.renderTable=!0,b.resultHeaders=[];for(var c=0;c<a.cols.length;c++)b.resultHeaders.push(a.cols[c]);b.rows=a.rows,b.status=a.status(),b.statement=d+";",e.updateInput(b.statement)}).error(function(a){h.stop(),b.error.hide=!1,b.renderTable=!1,b.error=a.error,b.showErrorTrace||g||(b.toggleOptions(),g=!0,localStorage.setItem("crate.console.displayed_error_trace_hint","1")),b.status=a.status(),b.rows=[],b.resultHeaders=[]}))},d.updateStatement=function(a){f=a||""},b.execute=function(){d.execute(f)}}]}}]).directive("cli",["$timeout",function(a){return{restrict:"E",transclude:!0,templateUrl:"views/editor.html",scope:{mimeType:"=",theme:"="},require:"^console",link:function(b,c,d,e){function f(a,b){return a+b>0?a+b:0}e.setInputScope(b),b.recentCursor=0,b.updateInput=function(a){j(a)};var g="",h="",i=$("textarea",c)[0],j=function(b){b&&k.setValue(b),a(function(){k.execCommand("selectAll")},10)},k=CodeMirror.fromTextArea(i,{mode:d.mimeType,theme:d.theme});k.on("change",function(a,b){g=a.getValue(),e.updateStatement(g)}),k.on("keydown",function(a,c){var d=c.target.selectionStart,i=e.recentQueries.length,k=g.indexOf(";"),l=a.getCursor(),m=a.getSelection();c.shiftKey||38!==c.keyCode?c.shiftKey||40!==c.keyCode?13===c.keyCode&&c.shiftKey?-1!=k&&(c.preventDefault(),e.execute(g),h=""):b.recentCursor=0:(d>=c.target.textLength||0===d&&c.target.selectionEnd===g.length)&&i+b.recentCursor<i&&(b.recentCursor++,g=e.recentQueries[f(i,b.recentCursor)]||h,j(g)):(0===l.ch&&0===l.line||0===l.line&&m===g)&&(0===b.recentCursor&&(h=g),b.recentCursor--,g=e.recentQueries[f(i,b.recentCursor)]||"",j(g))})}}}]).controller("ConsoleController",["$scope","$http","$location","SQLQuery","$log","$timeout",function(a,b,c,d,e,f){}]),angular.module("tables",["stats","sql","common","tableinfo"]).provider("TabNavigationInfo",function(){this.collapsed=[!1,!0],this.$get=function(){var a=this.collapsed;return{collapsed:a,toggleIndex:function(b){a[b]=!a[b]}}}}).factory("PartitionsTableController",function(){return function(){this.data=[],this.sort={col:"partition_ident",desc:!1},this.setPartitions=function(a){this.data=a},this.sortByColumn=function(a){this.sort.col===a?this.sort.desc=!this.sort.desc:(this.sort.col=a,this.sort.desc=!1)},this.selected=function(a){return a===this.sort.col?this.sort.desc?"fa fa-chevron-down":"fa fa-chevron-up":""}}}).controller("TableDetailController",["$scope","$location","$log","$timeout","$route","SQLQuery","queryResultToObjects","roundWithUnitFilter","bytesFilter","TableList","TableInfo","TabNavigationInfo","PartitionsTableController",function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n=null,o={},p={good:"",warning:"label-warning",critical:"label-danger","--":""},q={name:"",summary:"",health:"--",health_label_class:"",health_panel_class:"",records_total:0,records_replicated:0,records_underreplicated:0,records_unavailable:0,shards_configured:0,shards_started:0,shards_missing:0,shards_underreplicated:0,replicas_configured:"0",size:0,recovery_percent:0},r=e.current;a.$on("$locationChangeSuccess",function(a){if("TableDetailController"===e.current.$$route.controller){n&&(n(),n=null),t();var b=e.current.params;u(b.schema_name,b.table_name),e.current=r,e.current.params=b}}),$("[rel=tooltip]").tooltip({placement:"top"}),a.toggleSidebar=function(){$("#page-viewport").toggleClass("show-sidebar"),$(".menu-toggle i.fa").toggleClass("fa-angle-double-right").toggleClass("fa-angle-double-left")};var s=function(){return"r-"+(new Date).getTime()+"-"+Math.floor(1e3*Math.random())},t=function(){for(var a in o){var b=o[a];b.cancel()}o={}},u=function(b,c){a.ptCtlr=new m,a.nothingSelected=!1,a.renderSiderbar=!0,a.isParted=!1,n=a.$watch(function(){return j.data},function(e){var f=e.tables;if(f.length>0){var g=f.filter(function(a,d){return a.name===c&&a.schema_name===b});g=g.length?g[0]:f[0],a.table=g,a.table_label=g.name,"blob"==g.schema_name?a.table_label="BLOB: "+g.name:"doc"!=g.schema_name&&(a.table_label=g.schema_name+"."+g.name),a.nothingSelected=null===g,a.renderSidebar=!0,a.table.partitioned&&d()}else a.table=q,a.table_label=q.name,a.nothingSelected=!1,a.renderSidebar=!1,a.renderSchema=!1,a.renderPartitions=!1;a.nr_of_tables=f.length},!0);var d=function(){if(c&&b){var a='SELECT partition_ident, routing_state, state, relocating_node, "primary", SUM(num_docs), AVG(num_docs), COUNT(*), SUM(size) FROM sys.shards WHERE schema_name = ? AND table_name = ? AND partition_ident != \'\' GROUP BY partition_ident, routing_state, state, relocating_node, "primary"',d=s(),h=f.execute(a,[b,c]).success(function(a){if("undefined"!=typeof o[d]){var h="select partition_ident, number_of_shards, number_of_replicas, values from information_schema.table_partitions where schema_name = ? and table_name = ?",i=s(),j=f.execute(h,[b,c]).success(function(b){if("undefined"!=typeof o[i]){for(var c=[],d=g(a,["partition_ident","routing_state","state","relocating_node","primary","sum_docs","avg_docs","count","size"]),f=g(b,["partition_ident","number_of_shards","number_of_replicas","values"]),h=d.reduce(function(a,b,c){var d=b.partition_ident;return-1===a.indexOf(d)&&a.push(d),a},[]),j=0;j<h.length;j++){var l=h[j],m=d.filter(function(a,b){return a.partition_ident===l}),n=f.filter(function(a,b){return a.partition_ident===l});if(1===n.length){var q=new k(m,n[0].number_of_shards),r=q.asObject();r.partition_values=n[0].values,r.partition_ident=l,r.replicas_configured=n[0].number_of_replicas,r.health_label_class=p[r.health],c.push(r)}}e(!0,c,"undefined"==typeof o[i]),delete o[i]}}).error(function(a){e(!1,[],"undefined"==typeof o[i]),delete o[i]});delete o[d],o[i]=j}}).error(function(a){e(!1,[],"undefined"==typeof o[d]),delete o[d]});o[d]=h}},e=function(b,c,d){d||(a.ptCtlr.data=c,a.isParted=!0,a.renderPartitions=b,a.renderSchema=!0)};if(c&&b){var h="select column_name, data_type from information_schema.columns where schema_name = ? and table_name = ?";f.execute(h,[b,c]).success(function(b){a.schemaHeaders=b.cols,a.schemaRows=b.rows,a.renderSchema=!0}).error(function(b){a.renderSchema=!1})}a.$on("$destroy",function(){t(),n&&(n(),n=null)}),a.table=null,a.renderSidebar=!0,a.renderSchema=!1,a.renderPartitions=!1};u(e.current.params.schema_name,e.current.params.table_name)}]).controller("TableListController",["$scope","$route","TableList","TabNavigationInfo",function(a,b,c,d){a.$on("$locationChangeSuccess",function(a){if("TableDetailController"===b.current.$$route.controller){var c=b.current.params;e(c.schema_name,c.table_name)}});var e=function(b,e){a.renderSidebar=!0,a.$watch(function(){return c.data},function(c){var d=c.tables,f=d.length>0;if(a.renderSidebar=f,f){e&&b||(e=d[0].name,b=d[0].schema_name);var g=[];for(var h in d){var i=d[h].schema_name;"doc"==i||"blob"==i||g.indexOf(i)>-1||g.push(i)}a.tables=[],a.tables.push({display_name:"Doc",tables:d.filter(function(a,b){return"doc"==a.schema_name}),schema_name:"doc"});for(var h in g){var i=g[h];a.tables.push({display_name:i,tables:d.filter(function(a,b){return a.schema_name==i}),schema_name:i})}a.tables.push({display_name:"Blob",tables:d.filter(function(a,b){return"blob"==a.schema_name}),schema_name:"blob"})}else a.tables=[]},!0),a.isActive=function(a,c){return c===e&&a===b},a.startedShardsError=function(a){return a.partitioned&&0===a.shards_started?!1:a.shards_started<a.shards_configured},a.toggleElements=function(a){$("#nav-tabs-"+a).collapse("toggle"),$("#nav-tabs-header-"+a+" i.fa").toggleClass("fa-caret-down").toggleClass("fa-caret-right"),d.toggleIndex(a)},a.isCollapsed=function(a){return d.collapsed[a]}};e(b.current.params.schema_name,b.current.params.table_name)}]),angular.module("cluster",["stats","sql","common","nodeinfo"]).controller("NodeListController",["$scope","$route","ClusterState","prepareNodeList","NodeHealth","NodeListInfo","compareByHealth",function(a,b,c,d,e,f,g){a.nodes=[],a.selected=null,a.percentageLimitYellow=e.THRESHOLD_WARNING,a.percentageLimitRed=e.THRESHOLD_CRITICAL;var h=null,i=null,j=null;a.$on("$locationChangeSuccess",function(a){"NodeDetailController"===b.current.$$route.controller&&k(b.current.params.node_id)});var k=function(b){j=b,h&&h(),h=a.$watch(function(){return c.data},function(b){var c=angular.copy(b.cluster);i=b.version;var e=c.length>0;a.renderSidebar=e;var f=d(c,b.master_node);if(e){f=f.sort(g);var h=f.map(function(a){return a.id});if(j&&h.indexOf(j)>=0){var k=f.filter(function(a,b){return a.id===j});a.selected=k.length?k[0]:f[0]}else a.selected=f[0],j=f[0].id}else a.selected=null;a.nodes=f},!0)};a.sort=f.sort,a.sortBy=f.sortBy,a.sortClass=f.sortClass,a.isActive=function(a){return a.id===j},a.isSameVersion=function(a){return i?a.build_hash===i.hash:!0},k(b.current.params.node_id)}]).controller("NodeDetailController",["$scope","$interval","$route","$http","$filter","ClusterState","prepareNodeList","NodeHealth","compareByHealth",function(a,b,c,d,e,f,g,h,i){var j=e("bytes");a.node=null,a.percentageLimitYellow=h.THRESHOLD_WARNING,a.percentageLimitRed=h.THRESHOLD_CRITICAL;var k={name:"",id:"",summary:[],health:"--",health_label_class:"",health_panel_class:"",hostname:"--",address:"",version:{number:"--",build_hash:"",build_snapshot:!1},heap:{total:0,free:0,used:0,used_percent:0,free_percent:0},fs:{total:0,available:0,used:0,available_percent:0,used_percent:0},shardInfo:{started:-1,initializing:-1,reallocating:-1,postrecovery:-1}},l={used:"#55d4f5",free:"#e2e2e2"},m=null,n=null,o=c.current;a.$on("$locationChangeSuccess",function(a){if("NodeDetailController"===c.current.$$route.controller){var b=c.current.params;r(b.node_id),c.current=o,c.current.params=b}});var p=function(a){var b={total:0,available:0,used:0,available_percent:0,used_percent:0};if(a.fs.data){for(var c=[],d=0;d<a.fs.data.length;d++)c.push(a.fs.data[d].dev);for(var e=0;e<a.fs.disks.length;e++){var f=a.fs.disks[e],g=c.indexOf(f.dev)>-1;g&&(b.total+=f.size,b.available+=f.available,b.used+=f.used)}b.available_percent=100*b.available/b.total,b.used_percent=100*b.used/b.total}return b},q=function(a,b){return a.filter(function(a){return a.state===b}).reduce(function(a,b){return a+b.count},0)},r=function(b){n&&n(),n=a.$watch(function(){return f.data},function(c){for(var d=angular.copy(c.cluster),e=angular.copy(c.shards),f=0;f<d.length;f++)d[f].fs=p(d[f]);m=c.version;var h=d.length>0;a.renderSidebar=h;var j=g(d,c.master_node);if(h){j=j.sort(i);var l=j.map(function(a){return a.id});if(b&&l.indexOf(b)>=0){var n=j.filter(function(a,c){return a.id==b});a.node=n.length?n[0]:j[0]}else a.node=j[0];s(a.node)}else a.node=angular.copy(k);if(e&&e.length){var o=e.filter(function(b){return b.node_id===a.node.id});a.shardInfo={started:q(o,"STARTED"),initializing:q(o,"INITIALIZING"),reallocating:q(o,"REALLOCATING"),postrecovery:q(o,"POST_RECOVERY")}}},!0)};a.toolTipUsedPercentFunction=function(){return function(a,b,c,d,e){return"<p>"+a+"<br /><b>"+c+"%</b></p>"}},a.toolTipUsedBytesFunction=function(){return function(a,b,c,d,e){return"<p>"+a+"<br /><b>"+c+"</b></p>"}},a.yAxisByteFormatFunction=function(){return function(a){return j(a,2)}};var s=function(b){a.cpuData=[{key:"System",values:[["CPU",b.cpu.system]],color:l.used},{key:"User",values:[["CPU",b.cpu.user]],color:"#5987ff"},{key:"Idle",values:[["CPU",Math.max(0,100-b.cpu.system-b.cpu.user-b.cpu.stolen)]],color:l.free},{key:"Stolen",values:[["CPU",b.cpu.stolen]],color:"#ff814d"}],a.heapData=[{key:"Used",values:[["HEAP",b.heap.used]],color:l.used},{key:"Free",values:[["HEAP",b.heap.max-b.heap.used]],color:l.free}],a.diskUsageData=[{key:"Used",values:[["Disk Usage",b.fs.used]],color:l.used},{key:"Free",values:[["Disk Usage",b.fs.available]],color:l.free}],a.processCpuData=[{key:"Used",values:[["Process CPU",Math.min(100,b.proc_cpu.percent/b.num_cores)]],color:l.used},{key:"Idle",values:[["Process CPU",Math.max(0,100-b.proc_cpu.percent/b.num_cores)]],color:l.free}]};$("[rel=tooltip]").tooltip({placement:"top"}),a.toggleSidebar=function(){$("#page-viewport").toggleClass("show-sidebar"),$(".menu-toggle i.fa").toggleClass("fa-angle-double-right").toggleClass("fa-angle-double-left")},a.isSameVersion=function(a){return m?a.build_hash===m.hash:!0},r(c.current.params.node_id)}]),angular.module("common").filter("capitalize",function(){return function(a,b){return a.substring(0,1).toUpperCase()+a.substring(1)}}),angular.module("common").filter("floor",["$filter",function(a){return function(b,c){var d=Math.pow(10,c);return a("number")(Math.floor(b*d)/d,c)}}]).filter("roundWithUnit",["$filter","$sce",function(a,b){return function(c,d){void 0==d&&(d=3);var e="";return e=Math.abs(Number(c))>=1e9?a("number")(Math.abs(Number(c))/1e9,d)+" Billion":Math.abs(Number(c))>=1e6?a("number")(Math.abs(Number(c))/1e6,d)+" Million":a("number")(Math.abs(Number(c)),0),b.trustAsHtml(e)}}]).filter("bytes",["$sce",function(a){return function(b,c){if(isNaN(parseFloat(b))||!isFinite(b))return"-";if(0===b)return"0 B";"undefined"==typeof c&&(c=1);var d=["B","KB","MB","GB","TB","PB"],e=Math.floor(Math.log(b)/Math.log(1024)),f=(b/Math.pow(1024,Math.floor(e))).toFixed(c)+" "+d[e];return a.trustAsHtml(f)}}]);